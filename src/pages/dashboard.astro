---
import Layout from "../layouts/Layout.astro";
import { DashboardContainer } from "../components/dashboard/DashboardContainer";

export const prerender = false;

// Authorization check - redirect to login if not authenticated
const authToken = Astro.cookies.get("access_token")?.value;

if (!authToken) {
  return Astro.redirect("/login", 302);
}

// Prefetch dashboard data dla szybszego loadowania
let prefetchedData = null;
try {
  if (authToken) {
    const baseUrl = Astro.url.origin;
    const response = await fetch(`${baseUrl}/api/dashboard`, {
      headers: {
        Authorization: `Bearer ${authToken}`,
        "Content-Type": "application/json",
      },
    });
    
    if (response.ok) {
      const result = await response.json();
      prefetchedData = result.data;
    }
  }
} catch (error) {
  // Nie blokuj renderowania w przypadku błędu prefetch
  console.warn("Dashboard prefetch failed:", error);
}

// SEO metadata for dashboard
const pageTitle = "Dashboard - AI Flashcards";
---

<Layout title={pageTitle}>
  <main class="container mx-auto px-4 py-8 min-h-screen">
    <div class="max-w-6xl mx-auto">
      <!-- Dashboard Container with client-side hydration and prefetched data -->
      <DashboardContainer client:idle />
      
      <!-- Przekaż prefetched data do klienta -->
      {prefetchedData && (
        <script is:inline set:html={`
          if (typeof window !== "undefined") {
            window.__DASHBOARD_PREFETCH__ = ${JSON.stringify(prefetchedData)};
          }
        `}></script>
      )}
    </div>
  </main>
</Layout>
