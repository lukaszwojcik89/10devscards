---
import Layout from "../layouts/Layout.astro";
import { DashboardContainer } from "../components/dashboard/DashboardContainer";

export const prerender = false;

// Authorization check - redirect to login if not authenticated
const { request } = Astro;
const authToken = Astro.cookies.get("access_token")?.value;

if (!authToken) {
  return Astro.redirect("/login", 302);
}

// SEO metadata for dashboard
const pageTitle = "Dashboard - AI Flashcards";
const pageDescription = "Twój osobisty panel kontrolny do nauki z fiszkami. Sprawdź postępy, zaległości i zaplanuj kolejne sesje.";
---

<Layout title={pageTitle} description={pageDescription}>
  <main class="container mx-auto px-4 py-8 min-h-screen">
    <div class="max-w-6xl mx-auto">
      <!-- Dashboard Container with client-side hydration -->
      <DashboardContainer client:load />
    </div>
  </main>
</Layout>

<script>
  // Additional client-side auth check for extra security
  document.addEventListener("DOMContentLoaded", () => {
    const token = localStorage.getItem("access_token");
    if (!token) {
      window.location.href = "/login";
    }
  });
</script>
      </div>

      <!-- Header for guest users -->
      <header id="guest-header" class="text-center mb-16">
        <div class="mb-8">
          <h1 class="text-6xl font-bold bg-gradient-to-r from-indigo-600 via-purple-600 to-pink-600 bg-clip-text text-transparent mb-6">
            🧠 AI Flashcards
          </h1>
          <p class="text-2xl text-gray-600 mb-4">Ucz się efektywnie z fiszkami generowanymi przez sztuczną inteligencję</p>
          <p class="text-lg text-gray-500 max-w-2xl mx-auto">
            Wykorzystaj moc AI do tworzenia spersonalizowanych fiszek. Nauka nigdy nie była tak efektywna!
          </p>
        </div>
        
        <!-- Call to action for guests -->
        <div class="flex gap-6 justify-center flex-wrap mb-12">
          <a 
            href="/register" 
            class="px-8 py-4 bg-gradient-to-r from-indigo-600 to-purple-600 text-white rounded-xl hover:from-indigo-700 hover:to-purple-700 transition-all shadow-lg hover:shadow-xl font-semibold text-lg"
          >
            Rozpocznij za darmo
          </a>
          <a 
            href="/login" 
            class="px-8 py-4 bg-white/80 text-gray-700 rounded-xl hover:bg-white transition-all shadow-md hover:shadow-lg font-semibold text-lg border border-gray-200"
          >
            Zaloguj się
          </a>
        </div>
      </header>

      <!-- Features section -->
      <section class="grid grid-cols-1 md:grid-cols-3 gap-8 mb-16">
        <div class="bg-white/70 backdrop-blur-sm rounded-xl p-6 shadow-lg border border-gray-200/50 hover:shadow-xl transition-all">
          <div class="w-12 h-12 bg-gradient-to-br from-indigo-500 to-purple-600 rounded-xl flex items-center justify-center mb-4">
            <span class="text-white text-2xl">🚀</span>
          </div>
          <h3 class="text-xl font-semibold text-gray-800 mb-3">Generowanie AI</h3>
          <p class="text-gray-600">Automatycznie twórz fiszki używając sztucznej inteligencji na dowolny temat.</p>
        </div>
        
        <div class="bg-white/70 backdrop-blur-sm rounded-xl p-6 shadow-lg border border-gray-200/50 hover:shadow-xl transition-all">
          <div class="w-12 h-12 bg-gradient-to-br from-green-500 to-emerald-600 rounded-xl flex items-center justify-center mb-4">
            <span class="text-white text-2xl">📊</span>
          </div>
          <h3 class="text-xl font-semibold text-gray-800 mb-3">Inteligentne powtórki</h3>
          <p class="text-gray-600">System spaced repetition optymalizuje czas nauki i zwiększa efektywność.</p>
        </div>
        
        <div class="bg-white/70 backdrop-blur-sm rounded-xl p-6 shadow-lg border border-gray-200/50 hover:shadow-xl transition-all">
          <div class="w-12 h-12 bg-gradient-to-br from-pink-500 to-rose-600 rounded-xl flex items-center justify-center mb-4">
            <span class="text-white text-2xl">📈</span>
          </div>
          <h3 class="text-xl font-semibold text-gray-800 mb-3">Śledzenie postępów</h3>
          <p class="text-gray-600">Monitoruj swoje postępy i zobacz jak rośnie Twoja wiedza dzień po dniu.</p>
        </div>
      </section>
    </div>
  </main>
</Layout>

<script>
  document.addEventListener("DOMContentLoaded", async () => {
    const userWelcome = document.getElementById("user-welcome");
    const guestHeader = document.getElementById("guest-header");

    // Function to generate name from email
    function generateNameFromEmail(email) {
      const username = email.split('@')[0];
      // Capitalize first letter and replace dots/underscores with spaces
      return username
        .replace(/[._-]/g, ' ')
        .split(' ')
        .map(word => word.charAt(0).toUpperCase() + word.slice(1).toLowerCase())
        .join(' ');
    }

    // Check if user is logged in
    const token = localStorage.getItem("access_token");

    if (token) {
      try {
        const response = await fetch("/api/auth/me", {
          method: "GET",
          headers: {
            "Authorization": `Bearer ${token}`,
            "Content-Type": "application/json",
          },
        });

        if (response.ok) {
          // User is logged in
          const userData = await response.json();
          
          // Generate name from email
          const generatedName = generateNameFromEmail(userData.data.email);
          
          // Update greeting with user's name
          const userGreeting = document.getElementById("user-greeting");
          if (userGreeting) {
            userGreeting.textContent = `Witaj ponownie, ${generatedName}! 👋`;
          }
          
          userWelcome?.classList.remove("hidden");
          guestHeader?.classList.add("hidden");
        } else {
          throw new Error("Token invalid");
        }
      } catch {
        // Token invalid
        localStorage.removeItem("access_token");
        localStorage.removeItem("refresh_token");
        userWelcome?.classList.add("hidden");
        guestHeader?.classList.remove("hidden");
      }
    } else {
      // No token
      userWelcome?.classList.add("hidden");
      guestHeader?.classList.remove("hidden");
    }
  });
</script>
